<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todo List - Dashboard</title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <div class="background-animation"></div>
    <div class="container todo-container">
        <% if (messages && messages.success && messages.success.length > 0) { %>
            <div class="flash-message flash-success">
                <%= messages.success %>
            </div>
        <% } %>
        
        <% if (messages && messages.error && messages.error.length > 0) { %>
            <div class="flash-message flash-error">
                <%= messages.error %>
            </div>
        <% } %>
        
        <h2>Welcome, <%= user.username %>!</h2>
        <p class="welcome-message">Manage your tasks below</p>
        <div class="input-group todo-input">
            <input type="text" id="taskInput" placeholder="Add a new task" required>
            <button id="addTaskBtn">Add Task</button>
        </div>
        <ul class="task-list" id="taskList">
            <% if (todos && todos.length > 0) { %>
                <% todos.forEach(function(todo) { %>
                    <li class="task-item <%= todo.completed ? 'completed' : '' %>" data-id="<%= todo._id %>">
                        <input type="checkbox" <%= todo.completed ? 'checked' : '' %> class="toggle-complete">
                        <span class="task-text <%= todo.completed ? 'completed' : '' %>"><%= todo.title %></span>
                        <button class="delete-btn">Delete</button>
                    </li>
                <% }); %>
            <% } %>
        </ul>
        <a href="/logout" class="logout-link">Logout</a>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Add a new task
            document.getElementById('addTaskBtn').addEventListener('click', function() {
                addTask();
            });
            
            // Allow Enter key to add task
            document.getElementById('taskInput').addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    addTask();
                }
            });
            
            // Function to add task
            function addTask() {
                const taskInput = document.getElementById('taskInput');
                const text = taskInput.value.trim();
                if (text) {
                    fetch('/todos', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            title: text,
                            description: ''
                        })
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Server returned ' + response.status);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Successfully created todo:', data);
                        
                        // Create new task element
                        const li = document.createElement('li');
                        li.className = 'task-item';
                        li.setAttribute('data-id', data._id);
                        
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.className = 'toggle-complete';
                        checkbox.addEventListener('change', toggleComplete);
                        
                        const span = document.createElement('span');
                        span.className = 'task-text';
                        span.textContent = text;
                        
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'delete-btn';
                        deleteBtn.textContent = 'Delete';
                        deleteBtn.addEventListener('click', deleteTask);
                        
                        li.appendChild(checkbox);
                        li.appendChild(span);
                        li.appendChild(deleteBtn);
                        
                        document.getElementById('taskList').appendChild(li);
                        taskInput.value = '';
                    })
                    .catch(error => {
                        console.error('Error adding task:', error);
                        // Don't show alert - just log the error
                    });
                }
            }
            
            // Toggle task completion
            document.querySelectorAll('.toggle-complete').forEach(checkbox => {
                checkbox.addEventListener('change', toggleComplete);
            });
            
            function toggleComplete() {
                const li = this.closest('.task-item');
                const todoId = li.getAttribute('data-id');
                const completed = this.checked;
                
                fetch(`/todos/${todoId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        completed: completed
                    })
                })
                .then(response => {
                    if (response.ok) {
                        const textSpan = li.querySelector('.task-text');
                        if (completed) {
                            li.classList.add('completed');
                            textSpan.classList.add('completed');
                        } else {
                            li.classList.remove('completed');
                            textSpan.classList.remove('completed');
                        }
                    }
                })
                .catch(error => console.error('Error:', error));
            }
            
            // Delete task
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', deleteTask);
            });
            
            function deleteTask() {
                const li = this.closest('.task-item');
                const todoId = li.getAttribute('data-id');
                
                fetch(`/todos/${todoId}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    if (response.ok) {
                        li.remove();
                    }
                })
                .catch(error => console.error('Error:', error));
            }
        });
    </script>
</body>
</html>
